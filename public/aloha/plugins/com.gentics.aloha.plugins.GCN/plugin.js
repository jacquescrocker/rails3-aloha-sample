/*
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
GENTICS.Aloha.GCN=new GENTICS.Aloha.Plugin("com.gentics.aloha.plugins.GCN");GENTICS.Aloha.GCN.languages=["en","de","fr","eo"];GENTICS.Aloha.GCN.maximized=false;GENTICS.Aloha.GCN.buttons={};GENTICS.Aloha.GCN.restUrl="/CNPortletapp/rest";GENTICS.Aloha.GCN.init=function(){var that=this;var maximizeOptions=null;if(this.isGCNFrame()){jQuery("head").append('<link type="text/css" href="'+this.createGCNURL({url:that.settings.stag_prefix,params:{"do":20,url:"lib/css/gui.css"}})+'" rel="stylesheet">');jQuery("body").append('<div style="z-index: 999999; position: absolute; visibility: hidden" class="gentics_submenu" id="nodesubmenu1"> </div>');jQuery("head").append('<script type="text/javascript" src="'+this.createGCNURL({url:this.settings.stag_prefix,params:{"do":20,url:"lib/js/layer.js"}})+'"><\/script>');jQuery("head").append('<script type="text/javascript" src="'+this.createGCNURL({url:this.settings.stag_prefix,params:{"do":20,url:"lib/js/tools.js"}})+'"><\/script>');jQuery("head").append('<script type="text/javascript" src="'+this.createGCNURL({url:this.settings.stag_prefix,params:{"do":20,url:"lib/js/menu1.js"}})+'"><\/script>');if(top.menu){top.menu.location=this.createGCNURL({url:this.settings.stag_prefix,params:{"do":14004,MENU_LAYER:0,ass_pre_flapped:0,aloha:true}})}jQuery("html").click(function(){hide_layer(get_layer("nodesubmenu1"))})}GENTICS.Aloha.GCN.updateFrameUI();jQuery(window).unload(function(){that.restoreFrameUI();if(GENTICS.Aloha.isModified()){if(confirm(GENTICS.Aloha.i18n(GENTICS.Aloha,"confirm_editable_modified"))){that.savePage({silent:true,async:false});return false}}});this.alohaEditables(this.settings.editables);this.alohaBlocks(this.settings.blocks);if(this.settings.welcomeMessages){jQuery.each(this.settings.welcomeMessages,function(index,message){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:message.message,type:GENTICS.Aloha.Message.Type.ALERT}))})}if(GENTICS.Aloha.Log.isDebugEnabled()){var editables=0;var blocks=0;if(this.settings.editables){editables=this.settings.editables.length}if(this.settings.blocks){blocks=this.settings.blocks.length}GENTICS.Aloha.Log.debug(this,"Loaded page with id { "+this.settings.id+" }.");GENTICS.Aloha.Log.debug(this,"Found "+editables+" editables and "+blocks+" blocks.")}var pageMenu=new Array();pageMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.preview"),onclick:function(){that.previewPage()}}));pageMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.edit"),onclick:function(){that.editPage()}}));pageMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.livepreview"),onclick:function(){that.savePage({onsuccess:function(){that.openGCNURL({url:that.settings.stag_prefix,popup:true,params:{live:that.settings.id,"do":14001}})},onfailure:function(){},silent:true})}}));var propsBackParam=this.isGCNFrame()?"":'a:3:{s:4:"REDO";s:5:"14012";s:6:"realid";s:'+String(this.settings.id).length+':"'+this.settings.id+'";s:4:"real";s:4:"edit";}';pageMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.properties"),onclick:function(){that.openGCNURL({url:that.settings.stag_prefix,params:{"do":14000,PAGE_ID:that.settings.id,FOLDER_ID:that.settings.folderId,back:propsBackParam}})}}));var pageButton=new GENTICS.Aloha.ui.Button({label:this.i18n("button.page"),menu:pageMenu});GENTICS.Aloha.Ribbon.addButton(pageButton);if(this.settings.languageMenu&&this.settings.languageMenu.length>0){var menu=Array();jQuery.each(this.settings.languageMenu,function(index,language){menu.push(new GENTICS.Aloha.ui.Button({label:language.name,icon:that.createGCNURL({url:that.settings.stag_prefix,params:{"do":14203,base:"doc_hi.png",lang:language.code,module:"content"}}),onclick:function(){that.openGCNURL({url:that.settings.stag_prefix,params:{"do":14015,t_type:10007,redo:14001,CONTENTGROUP_ID:language.id}})}}))});GENTICS.Aloha.Ribbon.addButton(new GENTICS.Aloha.ui.Button({label:this.i18n("button.language"),menu:menu}))}var publishParams=this.isGCNFrame()?{"do":14003,cmd:"pub"}:{"do":14012,realid:this.settings.id,real:"pub"};var publishAtParams=this.isGCNFrame()?{"do":14021}:{"do":14021,PAGE_ID:this.settings.id,FOLDER_ID:this.settings.folderId,back:propsBackParam};var saveButtonMenu=Array();saveButtonMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.publish"),onclick:function(){that.openGCNURL({url:that.settings.stag_prefix,params:publishParams})}}));if(this.isGCNFrame()){saveButtonMenu.push(new GENTICS.Aloha.ui.Button({label:this.i18n("button.publishat"),onclick:function(){that.openGCNURL({url:that.settings.stag_prefix,params:publishAtParams})}}))}var saveButton=new GENTICS.Aloha.ui.Button({label:this.i18n("button.save"),onclick:function(){that.savePage()},menu:saveButtonMenu});GENTICS.Aloha.Ribbon.addButton(saveButton);if(GENTICS.Aloha.settings.readonly){GENTICS.Aloha.Ribbon.addButton(new GENTICS.Aloha.ui.Button({label:this.i18n("button.quit"),onclick:function(){that.quitEdit()}}))}else{var cancelButton=new GENTICS.Aloha.ui.Button({label:this.i18n("button.cancel"),onclick:function(){that.cancelEdit(function(){that.previewPage()})},menu:[new GENTICS.Aloha.ui.Button({label:this.i18n("button.quit"),onclick:function(){that.quitEdit()}})]});GENTICS.Aloha.Ribbon.addButton(cancelButton)}if(this.isGCNFrame()){GENTICS.Aloha.Ribbon.hide()}GENTICS.Aloha.Ribbon.setIcon("GENTICS_logo");var contentTagsMenu=new Array();var constructs=new Array();if(this.settings.constructCategories){for(var i=0;i<this.settings.constructCategories.length;i++){constructs=new Array();for(var j=0;j<this.settings.constructCategories[i].constructs.length;j++){constructs.push(new GENTICS.Aloha.ui.Button({label:this.settings.constructCategories[i].constructs[j].name,icon:this.createGCNURL({url:that.settings.stag_prefix,params:{"do":11,img:"constr/"+this.settings.constructCategories[i].constructs[j].icon,module:"content"}}),constructId:this.settings.constructCategories[i].constructs[j].id,onclick:function(){that.createTag(this.constructId)}}))}contentTagsMenu.push(new GENTICS.Aloha.ui.Button({label:this.settings.constructCategories[i].name,icon:this.createGCNURL({url:that.settings.stag_prefix,params:{"do":11,img:"constructopen.gif",module:"content"}}),menu:constructs,onclick:function(){}}))}if(contentTagsMenu.length>0){GENTICS.Aloha.FloatingMenu.addButton("GENTICS.Aloha.continuoustext",new GENTICS.Aloha.ui.Button({tooltip:this.i18n("insert_tag"),icon:this.createGCNURL({url:that.settings.stag_prefix,params:{"do":11,img:"constructopen.gif",module:"content"}}),menu:contentTagsMenu,size:"medium"}),GENTICS.Aloha.i18n(GENTICS.Aloha,"floatingmenu.tab.insert"),1)}}};GENTICS.Aloha.GCN.alohaEditables=function(editables){if(editables){jQuery.each(editables,function(index,editable){jQuery("#"+editable.id).aloha()})}};GENTICS.Aloha.GCN.alohaBlocks=function(blocks){if(blocks){jQuery.each(blocks,function(index,block){jQuery("#"+block.id).addClass("GENTICS_block").attr("contentEditable",false);if(!GENTICS.Aloha.settings.readonly){var imgTag=jQuery("<img>");imgTag.attr("border",0);imgTag.attr("src",block.iconurl);var buttonTag=jQuery("<button>");buttonTag.click(function(){GENTICS.Aloha.GCN.openTagFill(block.tagid)});buttonTag.attr("alt",block.icontitle);buttonTag.attr("title",block.icontitle);buttonTag.addClass("GENTICS_editicon");buttonTag.prepend(imgTag);jQuery("#"+block.id).prepend(buttonTag)}})}};GENTICS.Aloha.GCN.maximizeOptions={fsContent_cols:"0,*,0",frameset0_cols:"315,*",frameset2_rows:"101,*"};GENTICS.Aloha.GCN.toggleEditFrame=function(){if(!top.main){return}if(this.isEditFrameMaximized()){this.normalizeEditFrame()}else{this.maximizeEditFrame()}};GENTICS.Aloha.GCN.normalizeEditFrame=function(){top.main.document.getElementById("fsContent").cols=this.maximizeOptions.fsContent_cols;top.document.getElementsByTagName("frameset")[0].cols=this.maximizeOptions.frameset0_cols;top.document.getElementsByTagName("frameset")[2].rows=this.maximizeOptions.frameset2_rows;this.buttons.maximizeButton.setPressed(false)};GENTICS.Aloha.GCN.maximizeEditFrame=function(){this.maximizeOptions.fsContent_cols=top.main.document.getElementById("fsContent").cols;this.maximizeOptions.frameset0_cols=top.document.getElementsByTagName("frameset")[0].cols;this.maximizeOptions.frameset2_rows=top.document.getElementsByTagName("frameset")[2].rows;top.main.document.getElementById("fsContent").cols="0,*,0";top.document.getElementsByTagName("frameset")[0].cols="0,*";top.document.getElementsByTagName("frameset")[2].rows="0,*";this.buttons.maximizeButton.setPressed(true)};GENTICS.Aloha.GCN.isEditFrameMaximized=function(){if(!this.isGCNFrame()){return false}if(top.document.getElementsByTagName("frameset")[0].cols=="0,*"){return true}else{return false}};GENTICS.Aloha.GCN.isGCNFrame=function(){if(!window.parent){return false}var assistant=jQuery("frame",window.parent.document).eq(0);if(assistant.attr("name")==="ass"){return true}assistant=jQuery("frame",window.parent.document).eq(2);if(assistant.attr("name")==="ass"){return true}return false};GENTICS.Aloha.GCN.updateFrameUI=function(){if(this.isGCNFrame()){var assistantFrameset=jQuery("frameset",window.parent.document);this.originalColumns=assistantFrameset.attr("cols");this.originalRows=assistantFrameset.attr("rows");if(this.originalColumns){assistantFrameset.attr("cols","0,*,0")}if(this.originalRows){assistantFrameset.attr("rows","*,0,0")}var menuFrame=jQuery(window.parent.parent.frames[2].document);menuFrame.find("#ProgressStatusInfo_0").hide()}};GENTICS.Aloha.GCN.restoreFrameUI=function(){if(this.isGCNFrame()){var assistantFrameset=jQuery("frameset",window.parent.document);if(this.originalColumns){assistantFrameset.attr("cols",this.originalColumns)}if(this.originalRows){assistantFrameset.attr("rows",this.originalRows)}}};GENTICS.Aloha.GCN.cancelEdit=function(callback){var that=this;this.performRESTRequest({url:this.restUrl+"/page/cancel/"+this.settings.id,description:"restcall.cancelpage",success:callback,error:function(data){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:that.i18n("restcall.cancelpage.error"),type:GENTICS.Aloha.Message.Type.ALERT}))}})};GENTICS.Aloha.GCN.quitEdit=function(){var that=this;if(this.isEditFrameMaximized()){this.normalizeEditFrame()}this.cancelEdit(function(){if(that.settings.backurl){document.location.href=that.settings.backurl}else{if(that.isGCNFrame()){that.openGCNURL({url:that.settings.stag_prefix,params:{"do":13011}})}else{that.openGCNURL({url:that.settings.stag_prefix,params:{"do":14300,close:true}})}}})};GENTICS.Aloha.GCN.previewPage=function(){var that=this;this.openGCNURL({url:"/CNPortletapp/alohapage",params:{realid:that.settings.id,language:jQuery(document).getUrlParam("language"),real:"view"}})};GENTICS.Aloha.GCN.editPage=function(){var that=this;this.openGCNURL({url:"/CNPortletapp/alohapage",params:{realid:that.settings.id,language:jQuery(document).getUrlParam("language"),real:"edit"}})};GENTICS.Aloha.GCN.savePage=function(data){var that=this;if(typeof data=="undefined"){data={}}if(typeof data.async=="undefined"){data.async=true}if(!data.async){var saveProgress=new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:GENTICS.Aloha.i18n(that,"save.progress"),type:GENTICS.Aloha.Message.Type.WAIT});GENTICS.Aloha.showMessage(saveProgress)}var requestBody={unlock:data.closeAfterSave?true:false,page:{id:this.settings.id,templateId:this.settings.templateId,folderId:this.settings.folderId,name:this.settings.name,fileName:this.settings.fileName,description:this.settings.description,priority:this.settings.priority}};requestBody.page.tags={};for(var i=0;i<GENTICS.Aloha.editables.length;++i){var editable=GENTICS.Aloha.editables[i];var gcnEditable=this.findLoadedEditable(editable.getId());if(gcnEditable){var content=editable.getContents();content=content.replace(/<span class=\"GENTICS_block\" id=\"(\w+)\">x<\/span>/g,"<node $1>");var properties={};if(!requestBody.page.tags[gcnEditable.tagname]){requestBody.page.tags[gcnEditable.tagname]={name:gcnEditable.tagname,active:true,properties:{}}}requestBody.page.tags[gcnEditable.tagname].properties[gcnEditable.partname]={type:"RICHTEXT",stringValue:content}}else{}}var onsuccess=data?data.onsuccess:undefined;var onfailure=data?data.onfailure:undefined;if(typeof onfailure!="function"){onfailure=function(data){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:that.i18n("restcall.savepage.error"),type:GENTICS.Aloha.Message.Type.ALERT}))}}var showMessages=data&&data.silent?false:true;this.performRESTRequest({url:this.restUrl+"/page/save/"+this.settings.id,body:requestBody,description:"restcall.savepage",success:function(data){for(var i in GENTICS.Aloha.editables){if(GENTICS.Aloha.editables[i].setUnmodified){GENTICS.Aloha.editables[i].setUnmodified()}}if(typeof saveProgress!="undefined"){GENTICS.Aloha.hideMessage(saveProgress)}if(showMessages&&data.messages){jQuery.each(data.messages,function(index,message){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:message.message,type:GENTICS.Aloha.Message.Type.ALERT}))})}if(onsuccess){onsuccess(data)}},error:function(data){if(typeof saveProgress!="undefined"){GENTICS.Aloha.hideMessage(saveProgress)}if(onfailure){onfailure(data)}},async:data.async})};GENTICS.Aloha.GCN.publishPage=function(){var that=this;this.savePage({onsuccess:function(){var publishParams=that.isGCNFrame()?{"do":14003,cmd:"pub"}:{"do":14012,realid:that.settings.id,real:"pub"};that.openGCNURL({url:that.settings.stag_prefix,params:publishParams})},onfailure:function(){}})};GENTICS.Aloha.GCN.publishPageAt=function(){var that=this;this.savePage({onsuccess:function(){var propsBackParam=that.isGCNFrame()?"":'a:3:{s:4:"REDO";s:5:"14012";s:6:"realid";s:'+String(that.settings.id).length+':"'+that.settings.id+'";s:4:"real";s:4:"edit";}';var publishAtParams=that.isGCNFrame()?{"do":14021}:{"do":14021,PAGE_ID:that.settings.id,FOLDER_ID:that.settings.folderId,back:propsBackParam};that.openGCNURL({url:that.settings.stag_prefix,params:publishAtParams})},onfailure:function(){}})};GENTICS.Aloha.GCN.findLoadedEditable=function(id){if(this.settings.editables){for(var i=0;i<this.settings.editables.length;++i){if(this.settings.editables[i].id==id){return this.settings.editables[i]}}}};GENTICS.Aloha.GCN.makeClean=function(obj){if(this.settings.blocks){jQuery.each(this.settings.blocks,function(index,block){obj.find("#"+block.id).replaceWith('<span class="GENTICS_block" id="'+block.tagname+'">x</span>')})}};GENTICS.Aloha.GCN.performRESTRequest=function(data){var that=this;if(!data.type){data.type="POST"}var ajaxObject={type:data.type,dataType:"json",timeout:10000,contentType:"application/json; charset=utf-8",data:jQuery.toJSON(data.body)};ajaxObject.url=data.url+"?sid="+jQuery(document).getUrlParam("sid")+"&time="+(new Date()).getTime();if(data.params){for(var paramName in data.params){ajaxObject.url+="&"+paramName+"="+encodeURI(data.params[paramName])}}if(typeof data.async!="undefined"){ajaxObject.async=data.async}if(data.success){ajaxObject.success=data.success}if(data.error){ajaxObject.error=data.error}jQuery.ajax(ajaxObject)};GENTICS.Aloha.GCN.createGCNURL=function(data){var url=data.url+"?sid="+jQuery(document).getUrlParam("sid")+"&time="+(new Date()).getTime();for(var paramName in data.params){url+="&"+paramName+"="+encodeURI(data.params[paramName])}return url};GENTICS.Aloha.GCN.openGCNURL=function(data){var url=this.createGCNURL(data);var popup=data.popup;if(this.isEditFrameMaximized()){this.normalizeEditFrame()}this.openURL(url,popup)};GENTICS.Aloha.GCN.openURL=function(url,popup){if(GENTICS.Aloha.isModified()){this.savePage({unlock:false,onsuccess:function(){if(GENTICS.Aloha.Log.isDebugEnabled()){this.log("debug","opening url: "+url)}if(popup){window.open(url)}else{document.location.href=url}},silent:true,async:false})}else{if(GENTICS.Aloha.Log.isDebugEnabled()){this.log("debug","opening url: "+url)}if(popup){window.open(url)}else{document.location.href=url}}};GENTICS.Aloha.GCN.openTagFill=function(tagid){var that=this;var editdo=10008;var block=this.getBlock(tagid);if(block&&block.editdo){editdo=block.editdo}var tagfillBackParam=this.isGCNFrame()?"":"realid|"+this.settings.id;var editLink=this.createGCNURL({url:this.settings.stag_prefix,params:{"do":editdo,id:tagid,type:"page",keepsid:1,backparam:tagfillBackParam}});if(GENTICS.Aloha.isModified()){this.savePage({onsuccess:function(){window.open(editLink,"nodeeditor","dependent=yes,status=yes,scrollbars=yes,width=870,height=550,resizable=yes")},unlock:false,silent:true,async:false})}else{window.open(editLink,"nodeeditor","dependent=yes,status=yes,scrollbars=yes,width=870,height=550,resizable=yes")}};GENTICS.Aloha.GCN.createTag=function(constructId){var that=this;this.performRESTRequest({url:this.restUrl+"/page/newtag/"+this.settings.id,params:{constructId:constructId},description:"restcall.createtag",success:function(data){that.performRESTRequest({url:"/CNPortletapp/alohatag",type:"GET",params:{realid:that.settings.id,real:"edit",template:"<node "+data.tag.name+">",language:jQuery(document).getUrlParam("language")},success:function(data){that.handleBlock(data,true)},error:function(){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:GENTICS.Aloha.i18n(that,"restcall.createtag.error"),type:GENTICS.Aloha.Message.Type.ALERT}))}})}})};GENTICS.Aloha.GCN.getBlock=function(tagid){if(!this.settings.blocks){return false}for(var i=0;i<this.settings.blocks.length;++i){if(this.settings.blocks[i].tagid==tagid){return this.settings.blocks[i]}}return false};GENTICS.Aloha.GCN.reloadBlock=function(tagid){var block=this.getBlock(tagid);var that=this;if(!block){return}this.performRESTRequest({url:"/CNPortletapp/alohatag",type:"GET",params:{realid:that.settings.id,real:"edit",template:"<node "+block.tagname+">",language:jQuery(document).getUrlParam("language")},success:function(data){that.handleBlock(data,false)},error:function(){GENTICS.Aloha.showMessage(new GENTICS.Aloha.Message({title:"Gentics Content.Node",text:GENTICS.Aloha.i18n(that,"restcall.reloadtag.error"),type:GENTICS.Aloha.Message.Type.ALERT}))}})};GENTICS.Aloha.GCN.handleBlock=function(data,insert){var blockObj=jQuery(data.content);jQuery("#"+blockObj.attr("id")).replaceWith(data.content);if(insert){GENTICS.Aloha.Markup.insertHTMLCode(data.content)}if(data.editables){if(!this.settings.editables){this.settings.editables=new Array()}for(var i=0;i<data.editables.length;++i){this.settings.editables.push(data.editables[i])}this.alohaEditables(data.editables)}if(data.blocks){if(!this.settings.blocks){this.settings.blocks=new Array()}for(var i=0;i<data.blocks.length;++i){this.settings.blocks.push(data.blocks[i])}this.alohaBlocks(data.blocks)}};